apiVersion: v1
kind: ConfigMap
metadata:
  name: reverxy-config
data:
  config.yaml: |
    # Reverse proxy example configuration
    #
    # Notes:
    # - Durations use Go's time.ParseDuration format (e.g. "10s", "5m", "24h").
    # - Backend `health_url` may be absolute (https://host/health) or a relative path ("/health").
    #   If relative, it will be joined to the backend `url` (trim-righting any trailing slash).
    # - The names of keys must match the config struct tags in the code.
    #
    # Before running, ensure this file is loaded by your binary (e.g. via -config or env-driven loader).

    proxy:
      # Host/port the proxy listens on for client traffic
      host: "0.0.0.0"
      port: "8080"

      # Port to expose liveness/readiness probes (separate from main listen port)
      probe_port: "8085"

      # Default TTL used when no explicit cache headers found
      # Example: 5m (5 minutes)
      default_ttl: 5m

      # Maximum allowed TTL for any cached entry
      # Example: 24h (24 hours)
      max_age: 24h

    cache:
      # Disable caching entirely
      disabled: false

      # How frequently the in-memory cache should purge expired entries
      # Example: 10m (10 minutes)
      purge_interval: 10m

    load_balancer:
      # Type of load balancing to use. Supported values:
      # - "round-robin" (default)
      # - "weighted-round-robin" (uses per-backend `weight`)
      # - "least-connections" (requires connection tracking)
      type: "round-robin"

      pool:
        # Health checker configuration
        health_checker:
          # How often to run health checks against each backend
          # Example: 10s
          interval: 10s

          # How long to wait for a health check response before considering it a timeout
          # Example: 2s
          timeout: 2s

          # Maximum number of concurrent health checks
          # Example: 5
          max_concurrent_checks: 5

        # Backend pool configuration - list of backends to load balance
        # NOTE: These now point to Kubernetes service DNS names
        backends:
          - name: "backend-1"
            url: "http://backend-1:8081"
            # health_url can be absolute or relative (e.g. "/health")
            # If omitted, defaults to <url>/health
            health_url: "/health"
            weight: 1
            max_conns: 100

          - name: "backend-2"
            url: "http://backend-2:8082"
            # absolute health check URL
            health_url: "http://backend-2:8082/health"
            weight: 1
            max_conns: 100

          - name: "backend-3"
            url: "http://backend-3:8083"
            # health_url omitted -> will be computed as "<url>/health"
            weight: 1
            max_conns: 100

    rate_limiter:
      # Type of rate limiting to use
      # Supported values: "per-ip" (default)
      type: "per-ip"

      # Requests per second limit
      limit: 500

      # List of IPs to trust for X-Forwarded-For headers
      # If client IP is in this list, use the X-Forwarded-For value instead
      trusted_proxies:
        - "127.0.0.1"
        - "::1"
        # Add your reverse proxy IPs if running behind another proxy
        # - "10.0.0.0/8"