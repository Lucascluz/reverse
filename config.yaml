# Reverse proxy example configuration
#
# Notes:
# - Durations use Go's time.ParseDuration format (e.g. "10s", "5m", "24h").
# - Backend `health_url` may be absolute (https://host/health) or a relative path ("/health").
#   If relative, it will be joined to the backend `url` (trim-righting any trailing slash).
# - The names of keys must match the config struct tags in the code.
#
# Before running, ensure this file is loaded by your binary (e.g. via -config or env-driven loader).

proxy:
  # Host/port the proxy listens on for client traffic
  host: "0.0.0.0"
  port: "8080"

  # Port to expose liveness/readiness probes (separate from main listen port)
  probe_port: "8085"

  # Default TTL used when no explicit cache headers found
  # Example: 5m (5 minutes)
  default_ttl: 5m

  # Maximum allowed TTL for any cached entry
  # Example: 24h (24 hours)
  max_age: 24h

cache:
  # Disable caching entirely
  disabled: false

  # How frequently the in-memory cache should purge expired entries
  # Example: 10m (10 minutes)
  purge_interval: 10m

load_balancer:
  # Type of load balancing to use. Supported values:
  # - "round-robin" (default)
  # - "weighted-round-robin" (uses per-backend `weight`)
  # - "least-connections" (requires connection tracking)
  type: "round-robin"

  pool:
    # Health checker configuration
    health_checker:
      # How often to run health checks against each backend
      # Example: 10s
      interval: 10s

      # How long to wait for a health check response before considering it a timeout
      # Example: 2s
      timeout: 2s

      # Maximum number of concurrent health checks
      # Example: 5
      max_concurrent_checks: 5

    # Backend pool configuration - list of backends to load balance
    # NOTE: For testing with the provided load test scripts, ensure these addresses match:
    #   - Backend 1: localhost:8081
    #   - Backend 2: localhost:8082
    #   - Backend 3: localhost:8083
    # Start dummy backends with: ./scripts/test.sh backends-only
    backends:
      - name: "backend-1"
        url: "http://localhost:8081"
        # health_url can be absolute or relative (e.g. "/health")
        # If omitted, defaults to <url>/health
        health_url: "/health"
        weight: 1
        max_conns: 100

      - name: "backend-2"
        url: "http://localhost:8082"
        # absolute health check URL
        health_url: "http://localhost:8082/health"
        weight: 1
        max_conns: 100

      - name: "backend-3"
        url: "http://localhost:8083"
        # health_url omitted -> will be computed as "<url>/health"
        weight: 1
        max_conns: 100

rate_limiter:
  # Type of rate limiting to use
  # Supported values: "per-ip" (default)
  type: "per-ip"

  # Requests per second limit
  limit: 500

  # List of IPs to trust for X-Forwarded-For headers
  # If client IP is in this list, use the X-Forwarded-For value instead
  trusted_proxies:
    - "127.0.0.1"
    - "::1"
    # Add your reverse proxy IPs if running behind another proxy
    # - "10.0.0.0/8"

# Configuration Notes and Best Practices:
#
# Testing with Load Generation Scripts:
#   The ./scripts/test.sh script provides an integrated testing environment.
#   
#   Usage:
#     - Full test suite:  ./scripts/test.sh full
#     - Backends only:    ./scripts/test.sh backends-only
#     - Proxy only:       ./scripts/test.sh proxy-only
#     - Load test only:   ./scripts/test.sh load-test
#     - View logs:        ./scripts/test.sh logs
#   
#   Environment variables to customize:
#     export TEST_DURATION=60s    # How long to run the load test
#     export TEST_CLIENTS=10      # Number of concurrent clients
#     export TEST_RPS=100         # Requests per second per client
#     export NUM_BACKENDS=3       # Number of dummy backends to start
#
#   Example:
#     TEST_DURATION=120s TEST_CLIENTS=20 TEST_RPS=50 ./scripts/test.sh full
#
# Dummy Server Configuration:
#   Dummy backend servers are started on ports 8081, 8082, 8083 by default.
#   Each dummy server provides these endpoints:
#     - GET /health           - Health check endpoint
#     - GET /                 - Echo request details
#   
#   Each server can be customized with command line flags:
#     -port <number>          - Server port
#     -name <string>          - Server name (for identification)
#     -latency <ms>           - Response latency in milliseconds
#     -error-rate <0.0-1.0>   - Fraction of requests that fail
#     -healthy-delay <dur>    - Delay before marking as healthy
#
#   Example:
#     go run ./scripts/cmd/dummy-server/main.go -port 8081 -name backend-1 -latency 20
#
# Load Generator Configuration:
#   The load generator makes HTTP requests with randomized headers to test
#   the proxy's ability to handle various client patterns.
#   
#   Features:
#     - Random User-Agent headers
#     - Random Accept headers (JSON, HTML, etc.)
#     - Random Cache-Control directives
#     - Random X-Forwarded-For and X-Real-IP headers
#     - Random Authorization headers
#     - Request IDs and custom headers
#   
#   Usage:
#     go run ./scripts/cmd/loadgen/main.go \
#       -url=http://localhost:8080 \
#       -clients=10 \
#       -rps=100 \
#       -duration=60s \
#       -verbose=false
#
# Proxy Configuration:
#   - host: Bind address ("0.0.0.0" for all interfaces, "127.0.0.1" for localhost only)
#   - port: Main proxy port
#   - probe_port: Separate port for health/readiness probes
#   - default_ttl: Cache TTL when backend has no Cache-Control header
#   - max_age: Maximum cache duration regardless of backend headers
#
# Cache Configuration:
#   - disabled: Set to true to completely disable caching (useful for testing)
#   - purge_interval: How often to clean up expired entries from memory
#
# Load Balancer Configuration:
#   - type: Algorithm for selecting backends
#     * "round-robin": Simple round-robin distribution
#     * "weighted-round-robin": Uses weight field (1-100 typical)
#     * "least-connections": Selects backend with fewest active connections
#
# Pool Configuration:
#   - health_checker.interval: Check interval (10s recommended)
#   - health_checker.timeout: Response timeout (2s recommended)
#   - health_checker.max_concurrent_checks: Parallel checks (5+ recommended)
#
# Backend Configuration:
#   - url: Base URL of the backend service
#   - health_url: Path to health check endpoint (relative or absolute)
#   - weight: Importance in weighted balancing (1-100)
#   - max_conns: Maximum simultaneous connections allowed
#
# Rate Limiter Configuration:
#   - type: Limiting strategy
#   - limit: Requests per second per IP (adjust based on backend capacity)
#   - trusted_proxies: IPs to trust for X-Forwarded-For header