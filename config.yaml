# Reverse proxy example configuration
#
# Notes:
# - Durations use Go's time.ParseDuration format (e.g. "10s", "5m", "24h").
# - Backend `health_url` may be absolute (https://host/health) or a relative path ("/health").
#   If relative, it will be joined to the backend `url` (trim-righting any trailing slash).
# - The names of keys must match the config struct tags in the code:
#   Proxy: host, port, probe_port
#   Cache: disabled, default_ttl, max_age, purge_interval
#   Pool: backends, health_checker, load_balancer
#
# Before running, ensure this file is loaded by your binary (e.g. via -config or env-driven loader).

proxy:
  # Host/port the proxy listens on for client traffic
  host: "0.0.0.0"
  port: "8080"

  # Port to expose liveness/readiness probes (separate from main listen port)
  # Default in code: 8085 (if left empty). Example override:
  probe_port: "8085"

cache:
  # Disable caching entirely
  disabled: false

  # Default TTL used when no explicit cache headers found (e.g. no Cache-Control/Expires)
  # Example: 5m (5 minutes)
  default_ttl: 5m

  # Maximum allowed TTL for any cached entry (caps TTL determined from backend headers)
  # Example: 24h (24 hours)
  max_age: 24h

  # How frequently the in-memory cache should purge expired entries
  # Example: 10m (10 minutes)
  purge_interval: 10m

pool:
  # Backend pool configuration - contains backends, health checker and load balancer settings

  # Health checker configuration
  health_checker:
    # How often to run health checks against each backend
    # Example: 10s
    interval: 10s

    # How long to wait for a health check response before considering it a timeout
    # Example: 2s
    timeout: 2s

  # Load balancer configuration
  load_balancer:
    # Type of load balancing to use. Supported/expected values:
    # - "round-robin" (default)
    # - "least-connections"
    # - "weighted" (requires per-backend `weight` to be meaningful)
    #
    # Default in code: "round-robin" if empty.
    type: "round-robin"

  # Backends list. At least one backend MUST be present (the code validates this).
  backends:
    - name: "backend-1"                     # optional; defaults to "backend<N>" if omitted
      url: "http://localhost:8081"          # required
      # health_url can be absolute or relative (e.g. "/health"). If omitted, defaults to <url>/health
      health_url: "/health"
      weight: 1                             # optional, default: 1
      max_conns: 100                        # optional, default: 100

    - name: "backend-2"
      url: "http://localhost:8082"
      # absolute health check URL (overrides auto-built path)
      health_url: "http://localhost:8082/health"
      weight: 1
      max_conns: 100

    - name: "backend-3"
      url: "http://10.0.0.5:8080"
      # health_url omitted -> will be computed from url as "<url>/health"
      weight: 2    # useful when using weighted LB
      max_conns: 200

# Example notes and recommendations
#
# - Keep a single canonical default branch (main/master) protected and use short-lived
#   feature branches for changes. This file is just an example; adapt ports and hosts to your
#   deployment environment.
#
# - If you rely on cookies or vary headers for cache correctness, enable/implement the
#   Vary header verification and avoid caching responses that include Set-Cookie unless
#   explicitly intended.
#
# - For production, use health checks that return 200 for OK and non-200 for degraded/backoff.
#   Tune health_checker.interval and health_checker.timeout according to the backend responsiveness.
#
# - When using "least-connections" or "weighted" load balancers, ensure `max_conns` and
#   `weight` are configured for each backend appropriately.
#
# - If you want to disable cache for testing, set `cache.disabled: true`.
#
# - If you need TLS between proxy and backend, change backend URLs to https:// and ensure
#   your runtime HTTP client/trust store is configured accordingly.